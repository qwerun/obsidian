> [!info]  
> Hash-функции лежат в основе работы встроенной структуры `map` в Go. С выходом Go 1.24 реализация `map` претерпела значительные изменения, перейдя на модель Swiss Table, что улучшило производительность и управление коллизиями.

## Краткий конспект

- В Go `map` использует **хеш-функции**, специфичные для типов ключей, чаще всего `memhash`.
- Коллизии — неотъемлемая часть хеш-таблиц; они решаются через **цепочки** и **рандомизацию seed**.
- До Go 1.24 `map` использовал **бакеты** с массивами элементов и overflow-бакетами.
- В Go 1.24 введена **Swiss Table** — оптимизированный подход с метаданными и пробегом по 16 ключам.
- Новая реализация значительно уменьшает **число аллокаций и improves cache locality**.
- Для защиты от DoS важно понимать, как работает хеширование и избегать слабых ключей.

---

## Подробно

### Что такое хеш-функция

Хеш-функция — это функция, которая преобразует произвольные входные данные в фиксированное числовое значение (**хеш**). Хорошая хеш-функция должна:

- равномерно распределять ключи по таблице,
- быть быстрой,
- быть устойчивой к коллизиям.

В Go одна из основных хеш-функций — это **`memhash`**, реализованная в рантайме:

```go
// Используется для большинства встроенных типов (строк, чисел, массивов):
h := runtime.memhash(seed, ptr, len)
````

> [!tip]  
> Для пользовательских типов компилятор генерирует хеш-функции во время компиляции, основываясь на структуре полей.

---

### Коллизии: причины и стратегии

**Коллизия** возникает, когда два разных ключа дают одинаковый хеш.

#### Причины:

- одинаковые значения разных ключей (например, `“ab”` и `“ba”` при плохом хеше),
    
- маленький размер таблицы,
    
- преднамеренные атаки (DoS с миллионами конфликтных ключей).
    

#### Разрешение коллизий в Go:

- **Цепочки** (chaining): один бакет содержит до 8 пар ключ/значение. При переполнении создаются **overflow-бакеты**.
    
- **Рандомизация seed**: при запуске программы Go инициализирует случайное значение, участвующее в хешировании — это предотвращает предсказуемые хеши.


> [!example]  
> С одинаковыми строками, но разными seed'ами, `memhash` даст разные значения.

---

### Практические советы

#### Выбирайте простые ключи

Типы `int`, `string`, `uintptr` хешируются эффективно. Избегайте структур со слабо определённым `==` и `hash`.

```go
type Key struct {
  A int
  B [256]byte // неэффективно
}
```

#### Кастомное хеширование (опосредованно)

Go не позволяет напрямую передать свою хеш-функцию для `map`. Но можно использовать `map[string]T`, если вы контролируете формат строки.

#### Защита от DoS

- Никогда не доверяйте пользовательскому вводу в качестве `map`-ключей без обработки.
    
- Учитывайте, что `map[string]` устойчив к коллизиям из-за рандомизированного seed'а.


> [!tip]  
> Для более строгой защиты используйте внешние структуры, как `sync.Map` или шардированные `map` на больших нагрузках.

---

## FAQ

> [!faq]  
> **Q:** Можно ли задать свою хеш-функцию в Go `map`?  
> **A:** Нет, Go использует встроенные хеш-функции, сгенерированные компилятором или `memhash`.
>
> **Q:** Почему иногда `map` ведёт себя нестабильно между перезапусками?  
> **A:** Из-за рандомного seed’а: порядок итерации и hash может отличаться.
>
> **Q:** А можно ли использовать `interface{}` как ключ?  
> **A:** Только если значения сравнимы (== поддержан) и тип стабильный — иначе будет паника.
>
> **Q:** Насколько важно избегать больших struct в качестве ключа?  
> **A:** Очень важно — это влияет на скорость хеширования и сравнения.

---

## Полезные ссылки

- [Faster Go maps with Swiss Tables — go.dev](https://go.dev/blog/swisstable?utm_source=chatgpt.com)
    
- [Go 1.24 and the Swiss Table Revolution — Dev.to](https://dev.to/tuna99/go-124-and-the-swiss-table-revolution-a-new-era-for-maps-1pdj?utm_source=chatgpt.com)
    
- [Maps are faster in Go 1.24 — ByteSizeGo](https://www.bytesizego.com/blog/go-124-swiss-table-maps?utm_source=chatgpt.com)
    
- [Understanding Go's Supercharged Map in v1.24 — Devopsian](https://devopsian.net/p/understanding-gos-supercharged-map-in-v1.24/?utm_source=chatgpt.com)
    
- [Go source code — map implementation](https://github.com/golang/go/blob/master/src/runtime/map.go)
