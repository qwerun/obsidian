> [!info] Основная идея  
> Индексы в PostgreSQL ускоряют поиск, сортировку и фильтрацию данных, снижая нагрузку на операции `SELECT`. Они строятся по одному или нескольким столбцам таблицы и существенно повышают производительность при правильной настройке. PostgreSQL поддерживает разные типы индексов — B-tree, Hash, GIN, GiST, SP-GiST, BRIN и расширяемые, такие как Bloom. Каждый тип подходит под свою задачу, и выбор индекса зависит от характера запросов.

---

## Краткий конспект

- Индексы повышают скорость чтения, но увеличивают накладные расходы на запись.
- B-tree — индекс по умолчанию, подходит для большинства случаев.
- GIN, GiST — полезны для полнотекстового поиска и работы с массивами.
- Частичные и покрывающие (`INCLUDE`) индексы позволяют оптимизировать выборки.
- `EXPLAIN` помогает понять, используется ли индекс.
- Поддержка индексов включает мониторинг и периодическую перегенерацию (`REINDEX`).
- Избыточные индексы замедляют `INSERT`, `UPDATE`, `DELETE`.

---

## Что такое индекс и как он улучшает поиск

Индекс — это вспомогательная структура данных, которая ускоряет выполнение запросов, уменьшая количество строк, которые нужно просканировать.

Пример: если таблица `users` содержит миллионы записей, а мы часто ищем по `email`, то индекс по этому полю позволяет найти нужную строку быстро.

```sql
CREATE INDEX idx_users_email ON users(email);
```

Проверим использование индекса через `EXPLAIN`:

```sql
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
```

Ожидаем: `Index Scan using idx_users_email`.

---

## Плюсы и минусы использования индексов

**Плюсы:**
- Ускоряют `SELECT`, `JOIN`, `ORDER BY`, `WHERE`.
- Позволяют использовать покрывающие индексы для выборки без обращения к таблице.
- Частичные индексы экономят место и ускоряют запросы по условиям.

**Минусы:**
- Занимают место на диске.
- Замедляют `INSERT`, `UPDATE`, `DELETE`, так как требуют обновления.
- Нуждаются в обслуживании: REINDEX, мониторинг неиспользуемых.

> [!warning]
> Подводные камни  
> Лишние индексы могут сильно замедлить массовые обновления и удаления: каждый `UPDATE` приводит к пересозданию соответствующих индексных записей.

---

## Типы индексов

### B-tree

**Назначение:** универсальный, используется по умолчанию.  
**Когда использовать:** сравнение (`=`, `<`, `>`, `BETWEEN`, `ORDER BY`).  
**Пример:**
```sql
CREATE INDEX idx_price ON products(price);
```

**Ограничения:** неэффективен для `LIKE '%abc'`, JSONB, массивов и геоданных.

---

### Hash

**Назначение:** равенство =, особенно для фиксированной длины.  
**Когда использовать:** если нужны только точные сравнения.  
**Пример:**
```sql
CREATE INDEX idx_hash_email ON users USING hash(email);
```

**Ограничения:**
- До PostgreSQL 10 не поддерживались WAL и резервное копирование.
- Только = — ни `ORDER BY`, ни диапазоны.

---

### GiST (Generalized Search Tree)

**Назначение:** поиск по диапазонам, геоданным, полнотекст.  
**Когда использовать:** `@@`, `&&`, `@>`, `<<` и др.  
**Пример:**
```sql
CREATE INDEX idx_docs_gist ON documents USING gist(content);
```

**Ограничения:** требует настройки оператора; хуже работает на равенствах.

---

### SP-GiST (Space-partitioned GiST)

**Назначение:** дискретные структуры — IP-адреса, маршруты, деревья.  
**Когда использовать:** специфичные типы данных (CIDR, ltree).  
**Пример:**
```sql
CREATE INDEX idx_routes ON networks USING spgist(cidr);
```

**Ограничения:** не для обобщённого использования.

---

### GIN (Generalized Inverted Index)

**Назначение:** массивы, JSONB, полнотекстовый поиск.  
**Когда использовать:** `@>`, `?`, `@@`, `jsonb_path_ops`.  
**Пример:**
```sql
CREATE INDEX idx_tags ON posts USING gin(tags);
```

**Ограничения:**
- Медленно обновляется.
- Высокая стоимость вставки.

---

### BRIN (Block Range Index)

**Назначение:** большие таблицы с упорядоченными данными.  
**Когда использовать:** по времени, ID, дате.  
**Пример:**
```sql
CREATE INDEX idx_logs_brin ON logs USING brin(timestamp);
```

**Ограничения:** работает по блокам, не даёт точной выборки.

---

### Bloom (расширение)

**Назначение:** быстрое приближённое совпадение по нескольким столбцам.  
**Когда использовать:** при большом количестве колонок для `WHERE`.  
**Пример:**
```sql
CREATE EXTENSION bloom;
CREATE INDEX idx_bloom_multi ON events USING bloom(col1, col2, col3);
```

**Ограничения:** нет гарантий точности; возможны false positives.

---

## Многоколонковые и частичные индексы, покрытие

### Многоколонковый индекс

```sql
CREATE INDEX idx_name_email ON users(name, email);
```

> Используется, если запросы фильтруют по обоим полям слева направо.

### Частичный индекс

```sql
CREATE INDEX idx_active_users ON users(email) WHERE is_active = true;
```

> Эффективен, если условие часто повторяется.

### Покрывающий индекс (`INCLUDE`)

```sql
CREATE INDEX idx_order_cover ON orders(order_id) INCLUDE(total_price);
```

> Данные из `INCLUDE` не участвуют в сортировке, но позволяют делать `SELECT` без чтения таблицы.

---

## Советы по поддержке и мониторингу

- Используй `EXPLAIN` и `EXPLAIN ANALYZE` для анализа запросов.
- Проверяй, используются ли индексы:
  ```sql
  SELECT * FROM pg_stat_user_indexes WHERE idx_scan = 0;
  ```
- Периодически выполняй `REINDEX` для борьбы с фрагментацией:
  ```sql
  REINDEX INDEX idx_name;
  ```
- Удаляй неиспользуемые индексы — они тормозят запись.

> [!tip]
> Лучшие практики  
> - Всегда проверяй, используется ли индекс (`EXPLAIN`).  
> - Не индексируй всё подряд — анализируй рабочие запросы.  
> - Раз в квартал делай ревизию: какие индексы используются.  
> - Учитывай типы запросов: `GIN` — для JSON, `BRIN` — для логов.

---

> [!faq]  
> **Q:** Почему индекс не используется?  
> **A:** Возможно, плохая селективность или planner считает `Seq Scan` дешевле.  
>
> **Q:** Индекс увеличивает размер таблицы?  
> **A:** Индексы хранятся отдельно, но увеличивают общий размер базы.  
  >
> **Q:** Нужно ли VACUUM для индексов?  
> **A:** Да, `VACUUM` очищает \"мертвые\" строки и влияет на точность индекса.  
  >
> **Q:** Как бороться с фрагментацией?  
> **A:** Через `REINDEX`, особенно после массовых `DELETE`.

---

## Полезные ссылки

- [Index Types — PostgreSQL Docs](https://www.postgresql.org/docs/current/indexes-types.html?utm_source=chatgpt.com)
- [Indexes — PostgreSQL Docs](https://www.postgresql.org/docs/current/indexes.html?utm_source=chatgpt.com)
- [Index Maintenance — PostgreSQL Wiki](https://wiki.postgresql.org/wiki/Index_Maintenance?utm_source=chatgpt.com)
