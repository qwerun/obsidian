> [!info] Основная идея  
> Нормализация — это методика проектирования структуры базы данных, направленная на устранение избыточности и обеспечение логической целостности данных. В PostgreSQL нормализация особенно полезна для сложных систем с большим количеством связанных таблиц, где важно поддерживать читаемость, масштабируемость и удобство сопровождения данных.

---

## Краткий конспект

- **Нормализация** устраняет дублирование и повышает целостность данных.
- Каждая **нормальная форма** накладывает всё более строгие условия на таблицы.
- В PostgreSQL соблюдение форм достигается через структуру таблиц и внешние ключи.
- 1NF требует атомарности, 2NF — устранения частичных зависимостей, 3NF — исключения транзитивных.
- **BCNF** усиливает 3NF, устраняя даже те зависимости, что не нарушают первичный ключ.
- Ошибки нормализации могут привести к дублированию, аномалиям обновления и трудностям при масштабировании.

---

## Подробно

### Что такое нормализация?

**Нормализация** — это процесс организации данных в базе данных так, чтобы устранить избыточность и обеспечить логическую связность. Она основана на теории функциональных зависимостей между атрибутами и делится на последовательные **нормальные формы (Normal Forms)**.

Каждая следующая форма основывается на предыдущей и усиливает требования к структуре таблицы.

---

### Первая нормальная форма (1NF)

**Определение:**  
Таблица находится в **1NF**, если:

- Все значения в таблице **атомарны** (нет массивов, списков и т.п.).
- В таблице нет **повторяющихся групп** (повторяющихся колонок с похожим значением).

**До нормализации:**

```sql
CREATE TABLE orders_raw (
  order_id INT,
  customer TEXT,
  items TEXT  -- "apple,banana,orange"
);
````

**После нормализации (в 1NF):**

```sql
CREATE TABLE orders (
  order_id INT,
  customer TEXT,
  item TEXT
);
```

> [!tip]  
> Для соблюдения 1NF в PostgreSQL избегайте массивов и JSON, если данные предполагаются для аналитики или JOIN'ов.

---

### Вторая нормальная форма (2NF)

**Определение:**  
Таблица в **2NF**, если:

- Находится в **1NF**.
    
- Все **неключевые атрибуты** зависят **от всего первичного ключа**, а не его части.
    

**До нормализации:**

```sql
CREATE TABLE enrollment (
  student_id INT,
  course_id INT,
  student_name TEXT
);
-- ключ: (student_id, course_id)
```

Здесь `student_name` зависит только от `student_id`, а не от всего ключа.

**После нормализации:**

```sql
CREATE TABLE students (
  student_id INT PRIMARY KEY,
  student_name TEXT
);

CREATE TABLE enrollments (
  student_id INT,
  course_id INT,
  PRIMARY KEY (student_id, course_id),
  FOREIGN KEY (student_id) REFERENCES students(student_id)
);
```

> [!example]  
> В PostgreSQL это реализуется с помощью `FOREIGN KEY` и `PRIMARY KEY`.

---

### Третья нормальная форма (3NF)

**Определение:**  
Таблица в **3NF**, если:

- Находится в **2NF**.
    
- Все **неключевые атрибуты** не зависят **транзитивно** от ключа.
    

**До нормализации:**

```sql
CREATE TABLE employees (
  emp_id INT PRIMARY KEY,
  emp_name TEXT,
  dept_id INT,
  dept_name TEXT
);
```

`dept_name` зависит от `dept_id`, а не напрямую от `emp_id`.

**После нормализации:**

```sql
CREATE TABLE departments (
  dept_id INT PRIMARY KEY,
  dept_name TEXT
);

CREATE TABLE employees (
  emp_id INT PRIMARY KEY,
  emp_name TEXT,
  dept_id INT,
  FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
);
```

---

### Нормальная форма Бойса–Кодда (BCNF)

**Определение:**  
BCNF — это **усиленная 3NF**. Таблица находится в BCNF, если:

- Для каждой **функциональной зависимости A → B**, `A` является **ключом** таблицы.
    

**Пример нарушения BCNF:**

```sql
CREATE TABLE room_booking (
  room_no INT,
  time_slot TEXT,
  staff_id INT
);
-- Предположим, что: room_no + time_slot → staff_id
-- и одновременно: staff_id → room_no
```

Это нарушает BCNF, так как `staff_id` не является кандидатом на ключ, но определяет `room_no`.

**Решение:**

Разбить таблицу:

```sql
CREATE TABLE staff_rooms (
  staff_id INT PRIMARY KEY,
  room_no INT
);

CREATE TABLE bookings (
  room_no INT,
  time_slot TEXT,
  staff_id INT,
  PRIMARY KEY (room_no, time_slot),
  FOREIGN KEY (staff_id) REFERENCES staff_rooms(staff_id)
);
```

---

### Практические советы

> [!tip] Рекомендации  
> Используйте эти приёмы при проектировании схемы:

```sql
-- Объявите уникальный ключ для нормализации
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email TEXT UNIQUE
);

-- Используйте внешние ключи для соблюдения ссылочной целостности
CREATE TABLE posts (
  id SERIAL PRIMARY KEY,
  author_id INT,
  FOREIGN KEY (author_id) REFERENCES users(id)
);

-- Используйте ограничения для предотвращения "мусора"
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  price NUMERIC CHECK (price > 0)
);
```

---

> [!warning] Ошибки
> 
> - Дублирование данных в одной таблице (например, повторяющиеся адреса).
>     
> - Отказ от `FOREIGN KEY` во имя "гибкости".
>     
> - Использование массивов, JSON и `TEXT`-полей вместо отдельных таблиц.
>     
> - Проектирование без понимания функциональных зависимостей.
>     
> - Слишком ранняя денормализация во имя производительности.
>     

---

> [!faq]  
> **Q: Нужно ли всегда доходить до BCNF?**  
> A: Не обязательно. 3NF в большинстве случаев достаточно.
> 
> **Q: Зачем нормализовать, если данные маленькие?**  
> A: Нормализация помогает избегать логических ошибок и облегчает расширение модели.
> 
> **Q: Можно ли использовать массивы в PostgreSQL и соблюдать 1NF?**  
> A: Теоретически — нет. Атомарность нарушается.
> 
> **Q: Как проверить нормальную форму?**  
> A: Анализировать зависимости между атрибутами и определять, нарушают ли они правила форм.
---

### Полезные ссылки

- [PostgreSQL: Constraints and Foreign Keys](https://www.postgresql.org/docs/current/ddl-constraints.html)
    
- [DigitalOcean: Database Normalization](https://www.digitalocean.com/community/tutorials/database-normalization?utm_source=chatgpt.com)
    
- [freeCodeCamp: Normal Forms Guide](https://www.freecodecamp.org/news/database-normalization-1nf-2nf-3nf-table-examples/?utm_source=chatgpt.com)
    
- [TigerData: PostgreSQL Normalization](https://www.tigerdata.com/learn/how-to-use-postgresql-for-data-normalization?utm_source=chatgpt.com)
    
- [GeeksforGeeks: Normal Forms in DBMS](https://www.geeksforgeeks.org/dbms/normal-forms-in-dbms/?utm_source=chatgpt.com)
