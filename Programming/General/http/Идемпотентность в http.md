> [!info] Основная идея  
> Идемпотентность в HTTP означает, что повторный запрос не изменяет результат. Этот вопрос любят на интервью, потому что он проверяет знание сетевых гарантий и архитектурных решений.

---

## Краткий конспект

- Идемпотентный запрос можно безопасно повторять без изменения состояния сервера.
- Методы `GET`, `PUT`, `DELETE` — идемпотентны по стандарту.
- `POST` по умолчанию **не** идемпотентен.
- Идемпотентность важна при сетевых сбоях и повторах.
- Её можно реализовать через `Idempotency-Key`, контроль состояния или дедупликацию.

---

## Что такое идемпотентность?

Идемпотентность — это свойство, при котором **многократное выполнение операции даёт тот же результат**, что и одно выполнение.

> **Бытовой пример:** кнопка включения света с фиксированным положением. Нажать «вкл» дважды подряд — всё равно свет включён.

---

## Какие HTTP-методы считаются идемпотентными?

| Метод     | Идемпотентен? | Почему                            |
|-----------|---------------|------------------------------------|
| `GET`     | ✅            | Не изменяет данные, только читает |
| `HEAD`    | ✅            | Как `GET`, но без тела ответа     |
| `PUT`     | ✅            | Всегда заменяет ресурс            |
| `DELETE`  | ✅            | Удаляет один и тот же ресурс      |
| `OPTIONS` | ✅            | Запрос метаинформации             |
| `TRACE`   | ✅            | Тестирует путь запроса            |
| `POST`    | ❌            | Создаёт **новый** ресурс/состояние каждый раз |

> [!tip]
> Не путай: `GET` — безопасен **и** идемпотентен, `DELETE` — не безопасен, но идемпотентен.

---

## Как реализовать [[идемпотентность]] на POST?

### 1. **Заголовок `Idempotency-Key`**

Клиент генерирует уникальный ключ и повторно использует его при повторах:

```http
POST /payments
Idempotency-Key: abc-123

{ "amount": 100 }
```

Сервер сохраняет результат для этого ключа и возвращает тот же ответ при повторе.

---

### 2. **Контроль состояния ресурса**

Например, запрос на создание пользователя с тем же email:

```bash
curl -X POST /users -d '{"email": "a@b.com"}'
```

Сервер проверяет, существует ли уже такой пользователь, и возвращает `409 Conflict`, не создавая дубликатов.

---

### 3. **Дедупликация в БД**

На уровне бизнес-логики или базы — ключ уникальности (например, `transaction_id`) исключает повторное выполнение.

---

## Типовые вопросы на собеседовании

> [!faq]  
> **Q:** Что такое идемпотентность в HTTP?  
> **A:** Запрос можно выполнить несколько раз, и результат останется прежним.  
>  
> **Q:** Какие методы HTTP идемпотентны?  
> **A:** `GET`, `PUT`, `DELETE`, `HEAD`, `OPTIONS`, `TRACE`.  
>  
> **Q:** Почему `POST` не идемпотентен?  
> **A:** Каждый `POST` может создать новый ресурс или изменить состояние.  
>  
> **Q:** Зачем нужна идемпотентность?  
> **A:** Для надёжной обработки повторных запросов (например, при таймаутах).  
>  
> **Q:** Как реализовать идемпотентность при `POST`?  
> **A:** Через `Idempotency-Key`, проверку состояния, дедупликацию на уровне БД.

---

> [!warning]
> **Нюансы и подводные камни:**  
> - Повторы запросов могут происходить при сетевых сбоях или таймаутах.  
> - Даже идемпотентный метод может вызывать побочные эффекты (логгирование, счётчики).  
> - Без реализации контроля `POST` останется неидемпотентным.

---

## Полезные ссылки

- [RFC 9110: HTTP Semantics](https://www.rfc-editor.org/rfc/rfc9110.html?utm_source=chatgpt.com)
- [Idempotency-Key — IETF Draft](https://datatracker.ietf.org/doc/draft-ietf-httpapi-idempotency-key-header/?utm_source=chatgpt.com)
- [API Concepts: What is Idempotent? — FinalRoundAI](https://www.finalroundai.com/interview-questions/api-idempotent-topic?utm_source=chatgpt.com)

[[Идемпотентность в http|Предыдущая статья]]