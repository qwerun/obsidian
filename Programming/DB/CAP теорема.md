> [!info] **Главное:** 
> Теорема CAP объясняет, почему в распределённых системах нельзя одновременно добиться идеальной согласованности, доступности и устойчивости к сбоям сети.
> 
> - Одиночный PostgreSQL ≈ **CA** (консистентен и доступен, но к разделению неустойчив).
>     
> - Кластер с Patroni ≈ **CP** (жертвует доступностью ради целостности).
>     

---

> [!info] **Быстрый глоссарий**
> 
> - **Consistency** — одинаковые данные на всех узлах (`SERIALIZABLE` — самый строгий режим).
>     
> - **Availability** — база отвечает даже при сбоях (быстрый failover).
>     
> - **Partition Tolerance** — система продолжает работу при разрыве сети.
>     
> - **Quorum** — большинство узлов подтверждает переключение; иначе split-brain (два мастера).
>     

---

> [!info] **Как это работает в кластере**
> 
> 1. **Failover:** Patroni назначает реплику мастером, но только если есть кворум.
>     
> 2. **Разрыв сети:** кворума нет → новый мастер не выбирается → база останавливает запись, сохраняя целостность.
>     
> 3. **`SERIALIZABLE`:** предотвращает фантомы, но возможны откаты и падение производительности.
>     

---

> [!war] **Типичные ошибки**
> 
> - Путать `REPEATABLE READ` с полной консистентностью.
>     
> - Отключать synchronous-репликацию → потеря данных при аварии.
>     
> - Запускать Patroni без кворума → риск split-brain.
>     
> - Игнорировать лаг реплик и задержку WAL.
>     

---

> [!faq] **Часто задаваемые вопросы**  
> **Q:** PostgreSQL — CP или AP?  
> **A:** Соло-сервер — **CA**; кластер — **CP** (выбирает консистентность).  
> **Q:** Что, если мастер упал, а кворума нет?  
> **A:** Новый мастер не выбран → остановка записи, но данные целы.  
> **Q:** Можно писать в Standby?  
> **A:** Нет, только читать; частичную запись решает логическая репликация.

---

**Итог:** Понимание CAP-теоремы помогает сознательно выбирать между доступностью и строгой целостностью при проектировании кластера PostgreSQL, избегая split-brain и потери данных.