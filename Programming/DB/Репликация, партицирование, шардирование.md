> [!info]  
> Репликация, партиционирование и шардирование — три ключевые техники масштабирования и отказоустойчивости в PostgreSQL. Каждая из них помогает справляться с ростом нагрузки, объёма данных и требованиями к доступности, но решает разные задачи и требует разного уровня контроля.

---

## Краткий конспект

- **Репликация** повышает отказоустойчивость и масштабирует чтение путём копирования данных между узлами.
- **Партиционирование** делит большие таблицы на логически связанные части, упрощая запросы и повышая производительность.
- **Шардирование** распределяет данные между несколькими серверами для горизонтального масштабирования.
- PostgreSQL поддерживает **физическую и логическую репликацию** из коробки.
- Для сложного шардирования используются **расширения** (`citus`, `postgres_fdw`).
- Выбор между подходами зависит от характера нагрузки, роста данных и требований к масштабированию.

---

## Подробно

### Что такое репликация?

**Репликация** — это механизм копирования данных с одного сервера PostgreSQL (основного) на один или несколько других (реплик).

В PostgreSQL доступны два основных типа:

- **Физическая репликация** (Streaming Replication): передаёт WAL-файлы на уровне блоков.
- **Логическая репликация**: копирует изменения таблиц на уровне строк.

#### Преимущества:

- Высокая **отказоустойчивость**: реплики могут стать мастером.
- Масштабирование **чтения**: балансировка через реплики.
- Реплики можно использовать для резервного копирования.

#### Ограничения:

- Реплики (в физической репликации) нельзя изменять напрямую.
- Настройка требует внимательного управления `wal_level`, `archive_mode`, `hot_standby`.

#### Пример: настройка логической репликации

```sql
-- На основном сервере
CREATE PUBLICATION my_pub FOR TABLE users;

-- На подписчике
CREATE SUBSCRIPTION my_sub
  CONNECTION 'host=master port=5432 user=replicator dbname=main'
  PUBLICATION my_pub;
````

#### Сценарий:

Интернет-магазин с высокой нагрузкой на чтение выносит SELECT-запросы на реплики.

---

### Что такое партиционирование?

**Партиционирование** — это техника деления одной логической таблицы на несколько физических частей (партиций), управляемых как единое целое.

PostgreSQL поддерживает:

- **Диапазонное (range)** — по дате, ID и т.п.
    
- **Списковое (list)** — по значению (например, по региону).
    
- **Хэш-партиционирование** — для равномерного распределения.
    

#### Преимущества:

- **Ускорение запросов** за счёт секционирования (пропуск нерелевантных партиций).
    
- **Упрощение управления** большими таблицами (архивирование, удаление старых партиций).
    
- Возможность **параллельного выполнения** запросов.
    

#### Ограничения:

- Не все операции поддерживаются на уровне родительской таблицы.
    
- Ограниченная гибкость при динамическом создании партиций.
    

#### Пример: списковое партиционирование

```sql
CREATE TABLE orders (
  id serial,
  region text,
  amount numeric
) PARTITION BY LIST (region);

CREATE TABLE orders_eu PARTITION OF orders FOR VALUES IN ('EU');
CREATE TABLE orders_us PARTITION OF orders FOR VALUES IN ('US');
```

#### Сценарий:

Финтех-продукт делит транзакции по регионам для ускорения отчётов.

---

### Что такое шардирование?

**Шардирование** — это распределение данных по нескольким независимым PostgreSQL-инстансам (нодам). В отличие от партиционирования, шарды могут жить на разных машинах.

- Шардирование — это **горизонтальное деление одной логической таблицы между базами/нодами**.
    
- В отличие от партиционирования, здесь **каждый шард — это отдельная база или сервер**.
    
- Пример шардинга:
    
    - Пользователи с `user_id % 4 == 0` — в БД `shard0`
        
    - `user_id % 4 == 1` — в БД `shard1` и т.д.
        
- То есть **одна логическая таблица `orders` живёт на разных БД**, разбитая по ключу.

#### Преимущества:

- **Горизонтальное масштабирование**: больше данных, больше узлов.
    
- Распределённое выполнение SELECT/INSERT/UPDATE.
    
- Возможность масштабировать запись.
    

#### Ограничения:

- Усложнённая настройка, особенно без Citus.
    
- Некоторые запросы работают медленно без продуманного ключа шардирования.
    
- Потенциальные сложности с транзакциями между шардированными таблицами.
    

#### Пример: Citus-шардирование

```sql
-- настройка Citus
SELECT citus_enable();

-- шардирование по user_id
SELECT create_distributed_table('events', 'user_id');
```

#### Сценарий:

Сервис логирования с миллионами событий шардирует данные по `user_id`.

---

## Практика и подводные камни

> [!warning]
> 
> - Неверная настройка `wal_level` может нарушить репликацию.
>     
> - При партиционировании важно правильно выбрать ключ, иначе можно получить перекос нагрузки.
>     
> - Шардирование усложняет миграции и согласованность между шардами.
>     
> - Физическая репликация не даёт писать на репликах — только читать.
>     

> [!tip]
> 
> - Для репликации включите `wal_level = logical` (для логической) или `replica` (для физической).
>     
> - Для партиционирования по дате используйте `RANGE` и настройте автоматическое создание партиций.
>     
> - Citus хорошо работает с OLTP-нагрузкой, если выбрать подходящий шард-ключ.
>     
> - Используйте `pg_stat_replication` и `pg_stat_activity` для мониторинга.
>     
> - При использовании `postgres_fdw` учитывайте сетевые задержки и используйте `ANALYZE`.
>     

---

## Полезные ссылки

- [PostgreSQL: Репликация (официальная документация)](https://www.postgresql.org/docs/current/runtime-config-replication.html?utm_source=chatgpt.com)
    
- [PostgreSQL: Логическая репликация](https://www.postgresql.org/docs/current/logical-replication.html?utm_source=chatgpt.com)
    
- [PostgreSQL: Партиционирование таблиц](https://postgrespro.com/docs/postgresql/current/ddl-partitioning?utm_source=chatgpt.com)
    
- [Understanding partitioning and sharding in Postgres and Citus](https://www.citusdata.com/blog/2023/08/04/understanding-partitioning-and-sharding-in-postgres-and-citus/?utm_source=chatgpt.com)
    
- [PostgreSQL: Streaming Replication Protocol](https://www.postgresql.org/docs/current/protocol-replication.html?utm_source=chatgpt.com)
	