> [!info] **Основная идея**  
> Метаданные в gRPC — это дополнительные пары «ключ-значение», передаваемые между клиентом и сервером вместе с gRPC-вызовами. Они позволяют реализовать такие функции, как аутентификация, трассировка, локализация и управление контекстом. Это мощный инструмент, особенно полезный в распределённых системах.

---

## Краткий конспект  

- Метаданные реализуются как HTTP/2-заголовки в формате ключ-значение.
- Существуют три типа: request headers, response headers и response trailers.
- Часто применяются для авторизации, трассировки, передачи контекста.
- Устанавливаются и читаются через специальные API (`metadata.MD` в Go
- Есть ограничения на размер и формат ключей.
- Лучше всего обрабатывать их через middleware/interceptors.

---

## Подробно  

### Что такое метаданные?  

Метаданные в gRPC — это структура, основанная на HTTP/2-заголовках, представляющая собой список пар ключ-значение, которые сопровождают gRPC-вызов. Они не являются частью тела запроса или ответа, но тесно связаны с ним и могут передаваться как на стороне клиента, так и сервера.

- Ключи чувствительны к регистру.
- Ключи **не должны начинаться с префикса `grpc-`**, так как этот префикс зарезервирован для внутренних нужд gRPC.
- Метаданные применяются как для передачи служебной информации (например, авторизации), так и пользовательских параметров (локаль, версия клиента и т.п.).

---

### Виды метаданных  

#### Request headers  

Устанавливаются клиентом до начала передачи сообщений. Передаются в каждом вызове и доступны серверу через контекст запроса.

#### Response headers  

Устанавливаются сервером до отправки первого ответа. Отправляются один раз и могут содержать информацию о статусе, верификации, т.д.

#### Response trailers  

Передаются сервером в самом конце вызова. Обычно содержат статусные метки или отчёт о валидации запроса.

---

### Практические сценарии использования  

- **Аутентификация и авторизация**  
  ```http
  authorization: Bearer eyJhbGciOiJIUzI1NiIs...
  ```

- **Трассировка запросов**  
  ```http
  trace-id: 1ac73f00d
  span-id: 334cb15a
  ```

- **Передача пользовательского контекста**  
  ```http
  locale: ru-RU
  client-version: 2.3.1
  ```

> [!example]
> Можно добавить проверку `authorization` в `UnaryServerInterceptor`, извлекая токен из контекста.

---

### Примеры кода

#### Установка и чтение метаданных в Go  

```go
// client side — установка метаданных
md := metadata.Pairs("authorization", "Bearer token123")
ctx := metadata.NewOutgoingContext(context.Background(), md)
resp, err := client.SomeMethod(ctx, req)
```

```go
// server side — чтение метаданных
func (s *server) SomeMethod(ctx context.Context, req *pb.Request) (*pb.Response, error) {
  md, ok := metadata.FromIncomingContext(ctx)
  if ok {
    token := md["authorization"]
    // ...
  }
  return &pb.Response{}, nil
}
```

---

### Нюансы и подводные камни  

> [!warning] Ошибки и ограничения  
> - **Размер**: общая длина заголовков может быть ограничена (например, 8 КБ).  
> - **Зарезервированные ключи**: нельзя использовать префикс `grpc-` или `:`.  
> - **Логирование**: метаданные могут содержать чувствительную информацию — избегайте логирования без фильтрации.

---

> [!tip] Рекомендации  
> - Всегда проверяйте размер и структуру метаданных, особенно если они формируются динамически.  
> - Не передавайте токены и секреты в открытом виде — используйте [[TLS]].  
> - Обрабатывайте метаданные централизованно через middleware/interceptors.  
> - Не полагайтесь на порядок ключей: спецификация не гарантирует порядок при передаче.

---

> [!faq] Часто задаваемые вопросы  
>
> **Как задать несколько значений для одного ключа?**  
> В Go — повторно указать ключ в `metadata.Pairs`.
>
> **Можно ли отправлять бинарные данные?**  
> Да, если использовать ключ с окончанием `-bin` и сериализовать значение в Base64.
>

---

## Полезные ссылки  

- [gRPC Metadata Guide (официально)](https://grpc.io/docs/guides/metadata/?utm_source=chatgpt.com)  
- [grpc-examples на GitHub](https://github.com/grpc/grpc-java/tree/master/examples)  
- [Using metadata in gRPC with Golang](https://dev.to/techschoolguru/how-to-use-grpc-metadata-in-golang-4a5m)  
