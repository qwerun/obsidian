> [!info]  
> –í Go —Ñ—É–Ω–∫—Ü–∏—è `append` —Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ–º–∞–ª–æ –Ω—é–∞–Ω—Å–æ–≤: –æ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã—Ö –∫–∞–º–Ω–µ–π –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —Å–ª–∞–π—Å–∞ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏. –≠—Ç–∞ —Å—Ç–∞—Ç—å—è –æ–±—ä—è—Å–Ω–∏—Ç, **–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `append` –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö `len` –∏ `cap`**, –∏ –∫–∞–∫ –ø–∏—Å–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–¥.

---

## TL;DR

- `append` –∫–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ `cap` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏–Ω–∞—á–µ –ø–∏—à–µ—Ç –≤ —Ç–æ—Ç –∂–µ –º–∞—Å—Å–∏–≤.
- –ü—Ä–∏ `len < cap` ‚Äî –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –Ω–µ—Ç, –ø—Ä–∏ `len == cap` ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤.
- –†–æ—Å—Ç `cap` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ Go: –¥–æ 1024 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ‚Äî —É–¥–≤–æ–µ–Ω–∏–µ, –¥–∞–ª–µ–µ ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ.
- –ü–æ–¥—Å–ª–∞–π—Å—ã –º–æ–≥—É—Ç —Ä–∞–∑–¥–µ–ª—è—Ç—å –º–∞—Å—Å–∏–≤ ‚Äî `append` —Å–ø–æ—Å–æ–±–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å ¬´—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π¬ª —Å–ª–∞–π—Å.
- `append(dst, src...)` –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∞–ª–ª–æ–∫–∞—Ü–∏–∏.
- –í –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–π —Å—Ä–µ–¥–µ `append` –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ = –≥–æ–Ω–∫–∞.
- –ü–µ—Ä–µ–¥–∞—á–∞ —Å–ª–∞–π—Å–∞ –±–µ–∑ –∫–æ–ø–∏–∏ –º–æ–∂–µ—Ç —É—Ç–µ—á—å –Ω–∞—Ä—É–∂—É –∏ –≤—ã–∑–≤–∞—Ç—å `zero-copy pitfall`.

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç append: –ø–æ –∫–µ–π—Å–∞–º

### üìç `nil`-—Å–ª–∞–π—Å

```go
var s []int
s = append(s, 42)
fmt.Println(s) // [42]
````

`append` —Å `nil` —Å–ª–∞–π—Å–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π slice —Å cap=1.

---

### üìç `len < cap`

```go
s := make([]int, 2, 4)
s[0], s[1] = 1, 2
s = append(s, 3)
fmt.Println(s) // [1 2 3]
```

–≠–ª–µ–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç, **–Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è**.

---

### üìç `len == cap`

```go
s := []int{1, 2}
s = append(s, 3)
```

–°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤, –≤ –∫–æ—Ç–æ—Ä—ã–π –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ä–æ–≥–æ + –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ.

---

### üìç –†–æ—Å—Ç –ø–æ—Å–ª–µ 1024 —ç–ª–µ–º–µ–Ω—Ç–æ–≤

```go
s := make([]int, 1024)
for i := 0; i < 100000; i++ {
	s = append(s, i)
}
```

–î–æ cap=1024 —Ä–æ—Å—Ç –∏–¥—ë—Ç —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º √ó2. –ü–æ—Å–ª–µ ‚Äî –ø–æ —Ñ–æ—Ä–º—É–ª–µ:

> `newCap = oldCap + oldCap / 4` (–ø–ª—é—Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)

–≠—Ç–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–æ –≤ Go 1.18 –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –ø–∞–º—è—Ç—å—é.

> [!tip]  
> –ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞ cap:
> 
> ```
> cap: 1 ‚Üí 2 ‚Üí 4 ‚Üí 8 ‚Üí ... ‚Üí 1024 ‚Üí 1280 ‚Üí 1600 ‚Üí 2000 ‚Üí ...
> ```

> [!warning]  
> –ü–æ—Å–ª–µ cap ‚âà 1 GiB —Ä–æ—Å—Ç –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç —É–¥–≤–∞–∏–≤–∞—Ç—å—Å—è –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≤ runtime.

---

### üìç –°–ª–∞–π—Å—ã-–ø–æ–¥—Å–ª–∞–π—Å—ã: –æ–±—â–∏–µ –º–∞—Å—Å–∏–≤—ã

```go
a := []int{1, 2, 3, 4}
b := a[:2]
b = append(b, 99)
fmt.Println(a) // [1 2 99 4]
```

> [!warning]  
> `append` –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª –∏—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤, —Ç.–∫. cap –ø–æ–∑–≤–æ–ª—è–ª! –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–∞–≥–∞–º.

–ï—Å–ª–∏ `cap(b) < len(b)+1`, —Ç–æ –±—É–¥–µ—Ç –∞–ª–ª–æ–∫–∞—Ü–∏—è –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî `a` –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º.

---

### üìç –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å–ª–∞–π—Å–æ–≤: `append(dst, src...)`

```go
a := []int{1, 2}
b := []int{3, 4}
c := append(a, b...)
```

–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `len(b)` —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ê–ª–ª–æ–∫–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç, **–µ—Å–ª–∏ –≤ `a` –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ `cap`**.

---

### üìç –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏ data-race

```go
var s []int
go func() { s = append(s, 1) }()
go func() { s = append(s, 2) }()
```

> [!warning]  
> –≠—Ç–æ **data race**. Slice ‚Äî –Ω–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω. `append` –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å underlying array.

–†–µ—à–µ–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sync.Mutex`, `sync/atomic` –∏–ª–∏ –∫–∞–Ω–∞–ª.

---

### üìç Zero-copy pitfall

```go
func extend(s []byte) {
	s = append(s, 99) // –∞–ª–ª–æ–∫–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–∏–∑–æ–π—Ç–∏!
}
```

–ï—Å–ª–∏ `cap(s)` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤–Ω–µ—à–Ω—è—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±—É–¥–µ—Ç **–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –≤—Ç–∏—Ö—É—é**.

> [!example]  
> –î–µ–ª–∞–π —è–≤–Ω—É—é –∫–æ–ø–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ —Å–ª–∞–π—Å–∞, –µ—Å–ª–∏ –æ–Ω —É—è–∑–≤–∏–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```go
func safeExtend(s []byte) {
	s = append([]byte(nil), s...) // –∫–æ–ø–∏—è
}
```

> [!faq]  
> **Q:** append –≤—Å–µ–≥–¥–∞ –∞–ª–ª–æ—Ü–∏—Ä—É–µ—Ç?  
> **A:** –ù–µ—Ç. –¢–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º `cap`.
> 
> **Q:** –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª –ª–∏ `append` —Å –∞–ª–ª–æ–∫–∞—Ü–∏–µ–π?  
> **A:** –°—Ä–∞–≤–Ω–∏–≤–∞–π `&s[0]` –¥–æ –∏ –ø–æ—Å–ª–µ. –ò–ª–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–π —á–µ—Ä–µ–∑ `-benchmem`.
> 
> **Q:** –ú–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `nil` –≤ `append`?  
> **A:** –î–∞. –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å `nil`-—Å–ª–∞–π—Å–∞–º–∏.

---

## ‚öôÔ∏è –ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º

–§–∞–π–ª `runtime/slice.go` (Go 1.18+) —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–æ—Å—Ç–∞ —Ç–∞–∫:

```go
func growslice(et *_type, old slice, cap int) slice
```

–†–æ—Å—Ç –ø–∞–º—è—Ç–∏:

- –î–æ cap=1024: `newCap = oldCap * 2`
    
- –ü–æ—Å–ª–µ: `newCap = oldCap + oldCap / 4`
    

–° –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º `cap` –ø–æ —à–∞–≥—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞.

> [!tip]  
> –ú–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å `cap` –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `reflect`:

```go
import "reflect"

func Cap(ptr interface{}) int {
	v := reflect.ValueOf(ptr)
	return v.Cap()
}
```

---

## üìä –ë–µ–Ω—á–º–∞—Ä–∫–∏

```go
func BenchmarkAppendPrealloc(b *testing.B) {
	s := make([]int, 0, b.N)
	for i := 0; i < b.N; i++ {
		s = append(s, i)
	}
}

func BenchmarkAppendNoPrealloc(b *testing.B) {
	var s []int
	for i := 0; i < b.N; i++ {
		s = append(s, i)
	}
}
```

–ó–∞–ø—É—Å–∫:

```bash
go test -bench=. -benchmem
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

|–ë–µ–Ω—á–º–∞—Ä–∫|–ê–ª–ª–æ–∫–∞—Ü–∏–∏|–í—Ä–µ–º—è|
|---|---|---|
|AppendPrealloc|0|–±—ã—Å—Ç—Ä–µ–µ|
|AppendNoPrealloc|>0|–º–µ–¥–ª–µ–Ω–Ω–µ–µ|

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç: –∫–∞–∫ –ø–∏—Å–∞—Ç—å `append` –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `make([]T, 0, N)` –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å –Ω—É–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä.
    
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π `len` –∏ `cap`, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–ø–∏–π.
    
- ‚úÖ –ü–µ—Ä–µ–¥–∞–≤–∞–π –∫–æ–ø–∏—é, –µ—Å–ª–∏ —Å–ª–∞–π—Å –º–æ–∂–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏.
    
- ‚ùå –ù–µ –¥–µ–ª–∞–π `append` –≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –≥–æ—Ä—É—Ç–∏–Ω–∞—Ö –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
    
- ‚ùå –ù–µ –ø–æ–ª–∞–≥–∞–π—Å—è –Ω–∞ `append` –∫–∞–∫ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.
    

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Arrays, slices (and strings): The mechanics of 'append'](https://go.dev/blog/slices?utm_source=chatgpt.com)
    
- [Slice types ‚Äî Go Spec](https://go.dev/ref/spec?utm_source=chatgpt.com)
    
- [Go 1.18 Release Notes (slice growth changes)](https://go.dev/doc/go1.18?utm_source=chatgpt.com)
    
- [Slices in Go: Grow Big or Go Home ‚Äî VictoriaMetrics](https://victoriametrics.com/blog/go-slice/?utm_source=chatgpt.com)
    
- [[–£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –≤ Go]]
